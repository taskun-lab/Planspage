<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>æˆé•·ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</title>
  <style>
    :root {
      --bg-grad: linear-gradient(180deg, #f6edff 0%, #fdfbff 40%, #ffffff 100%);
      --card-bg: #ffffff;
      --accent: #8b5cf6;
      --accent-soft: #ede9fe;
      --text-main: #111827;
      --text-sub: #6b7280;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      background: var(--bg-grad);
      color: var(--text-main);
    }
    header {
      padding: 16px 16px 8px;
      text-align: center;
    }
    header h1 {
      margin: 0;
      font-size: 20px;
      font-weight: 700;
      color: var(--accent);
    }
    header p {
      margin: 4px 0 0;
      font-size: 12px;
      color: var(--text-sub);
    }

    main {
      padding: 0 12px 64px;
      max-width: 960px;
      margin: 0 auto;
    }
    .summary-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
      margin-bottom: 12px;
    }
    @media (max-width: 640px) {
      .summary-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }
    .summary-card {
      background: var(--card-bg);
      border-radius: 14px;
      padding: 10px 10px;
      box-shadow: 0 5px 15px rgba(0,0,0,.05);
    }
    .summary-label {
      font-size: 11px;
      color: var(--text-sub);
      margin-bottom: 4px;
    }
    .summary-value {
      font-size: 18px;
      font-weight: 700;
    }

    .panel {
      background: var(--card-bg);
      border-radius: 18px;
      padding: 14px 14px 18px;
      box-shadow: 0 8px 24px rgba(129,140,248,.12);
      margin-bottom: 12px;
    }
    .panel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
    }
    .panel-title {
      font-size: 13px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .panel-title span.icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 18px;
      height: 18px;
      border-radius: 999px;
      background: var(--accent-soft);
      color: var(--accent);
      font-size: 11px;
    }
    .panel-sub {
      font-size: 11px;
      color: var(--text-sub);
    }

    .chart-wrap {
      position: relative;
      height: 260px;
      margin-top: 4px;
    }

    .bottom-metrics {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
    }
    .metric-card {
      background: var(--card-bg);
      border-radius: 16px;
      padding: 12px 14px;
      box-shadow: 0 5px 18px rgba(0,0,0,.04);
    }
    .metric-label {
      font-size: 12px;
      color: var(--text-sub);
      margin-bottom: 4px;
    }
    .metric-main {
      font-size: 22px;
      font-weight: 700;
    }
    .metric-extra {
      font-size: 11px;
      color: var(--text-sub);
      margin-top: 2px;
    }

    /* bottom nav */
    nav.bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: 52px;
      background: #ffffffcc;
      backdrop-filter: blur(12px);
      border-top: 1px solid #e5e7eb;
      display: flex;
      justify-content: space-around;
      align-items: center;
      font-size: 10px;
      z-index: 20;
    }
    .nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 2px;
      color: #9ca3af;
      text-decoration: none;
    }
    .nav-item span.icon {
      font-size: 16px;
    }
    .nav-item.active {
      color: var(--accent);
      font-weight: 600;
    }

    .loading {
      text-align: center;
      font-size: 12px;
      color: var(--text-sub);
      padding: 24px 0;
    }
  </style>

  <!-- LIFF SDK & Chart.js -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<header>
  <h1>æˆé•·ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</h1>
  <p>ã‚ãªãŸã®æˆé•·ã‚’å¯è¦–åŒ–ã—ã¾ã™</p>
</header>

<main>
  <div id="loading" class="loading">èª­ã¿è¾¼ã¿ä¸­...</div>

  <div id="mainContent" style="display:none;">
    <section class="summary-grid" id="summaryGrid">
      <div class="summary-card">
        <div class="summary-label">ç·ã‚¿ã‚¹ã‚¯</div>
        <div class="summary-value" id="totalTasks">0</div>
      </div>
      <div class="summary-card">
        <div class="summary-label">å®Œäº†</div>
        <div class="summary-value" id="completedTasks">0</div>
      </div>
      <div class="summary-card">
        <div class="summary-label">é€²è¡Œä¸­</div>
        <div class="summary-value" id="activeTasks">0</div>
      </div>
      <div class="summary-card">
        <div class="summary-label">ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«</div>
        <div class="summary-value" id="journalCount">0</div>
      </div>
    </section>

    <section class="panel">
      <div class="panel-header">
        <div class="panel-title">
          <span class="icon">ğŸ“ˆ</span>
          æˆé•·ãƒ¬ãƒ¼ãƒ€ãƒ¼ãƒãƒ£ãƒ¼ãƒˆ
        </div>
        <div class="panel-sub" id="periodLabel">ç›´è¿‘7æ—¥é–“</div>
      </div>
      <div class="chart-wrap">
        <canvas id="radarChart"></canvas>
      </div>
    </section>

    <section class="bottom-metrics">
      <div class="metric-card">
        <div class="metric-label">ã‚¿ã‚¹ã‚¯å®Œäº†ç‡</div>
        <div class="metric-main">
          <span id="taskCompleteRate">0</span>%
        </div>
        <div class="metric-extra" id="taskCompleteDetail">0 / 0 ä»¶</div>
      </div>
      <div class="metric-card">
        <div class="metric-label">æ„å‘³é‡ã‚¹ã‚³ã‚¢</div>
        <div class="metric-main">
          <span id="meaningScore">0</span> / 100
        </div>
        <div class="metric-extra">ãƒ“ã‚¸ãƒ§ãƒ³ãƒ»æˆé•·ãƒ»ã‚ãã‚ãã®ç·åˆè©•ä¾¡</div>
      </div>
    </section>
  </div>
</main>

<nav class="bottom-nav">
  <!-- URLã¯å®Ÿéš›ã®LIFF URLã«å·®ã—æ›¿ãˆã¦ã­ -->
  <a href="https://liff.line.me/2008372898-2q9qWmxv" class="nav-item">
    <span class="icon">ğŸ“‹</span>
    <span>ã‚¿ã‚¹ã‚¯</span>
  </a>
  <a href="#" class="nav-item">
    <span class="icon">ğŸ““</span>
    <span>ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«</span>
  </a>
  <a href="#" class="nav-item active">
    <span class="icon">ğŸ“Š</span>
    <span>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</span>
  </a>
</nav>

<script>
  // â˜… ã‚¿ã‚¹ã‚¯ãƒšãƒ¼ã‚¸ã¨åŒã˜æ§‹æˆã«å¯„ã›ãŸå®šæ•°ãŸã¡
  // TODO: å®Ÿéš›ã®ã€Œã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç”¨ LIFF IDã€ã«å·®ã—æ›¿ãˆã¦ã­
  const LIFF_ID_STATUS = "YOUR_LIFF_ID_STATUS";
  const API_BASE = "https://yamasho.xvps.jp/webhook";

  let userId = null;
  let radarChart = null;

  /* ==========================
     initï¼ˆã‚¿ã‚¹ã‚¯ãƒšãƒ¼ã‚¸ã¨åŒã˜æµã‚Œï¼‰
  ========================== */
  async function init() {
    try {
      console.log("[STATUS] liff.init start");
      await liff.init({ liffId: LIFF_ID_STATUS });

      if (!liff.isLoggedIn()) {
        console.log("[STATUS] not logged in -> login()");
        liff.login();
        return;
      }

      const profile = await liff.getProfile();
      userId = profile.userId;
      console.log("[STATUS] userId:", userId);

      await loadStatus();
    } catch (e) {
      console.error("[STATUS] LIFF init error:", e);
      alert("LIFFåˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ");
      document.getElementById("loading").textContent = "LIFFåˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ";
    }
  }

  /* ==========================
     ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹èª­ã¿è¾¼ã¿
  ========================== */
  async function loadStatus() {
    const loadingEl = document.getElementById("loading");
    const mainContent = document.getElementById("mainContent");

    loadingEl.style.display = "block";
    mainContent.style.display = "none";

    const listUrl = `${API_BASE}/list?user_id=${encodeURIComponent(userId)}`;
    console.log("[STATUS] request:", listUrl);

    try {
      const res = await fetch(listUrl);
      const raw = await res.text();

      console.log("[STATUS] list status:", res.status);
      console.log("[STATUS] raw response:", JSON.stringify(raw));

      if (!res.ok) {
        console.error("[STATUS] http error:", res.status, raw);
        alert("ã‚¿ã‚¹ã‚¯ä¸€è¦§ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆHTTPã‚¨ãƒ©ãƒ¼ï¼‰");
        loadingEl.textContent = "èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸâ€¦";
        return;
      }

      if (!raw) {
        console.warn("[STATUS] ç©ºãƒ¬ã‚¹ãƒãƒ³ã‚¹ã§ã—ãŸ");
        const emptyList = { pinned: [], active: [], completed: [] };
        const journalStats = await fetchJournalStatsSafe();
        const statsEmpty = computeStats(emptyList, journalStats);

        renderSummary(statsEmpty);
        renderRadar(statsEmpty);
        renderBottomMetrics(statsEmpty);

        loadingEl.style.display = "none";
        mainContent.style.display = "block";
        return;
      }

      let listData;
      try {
        listData = JSON.parse(raw);
      } catch (e) {
        console.error("[STATUS] JSONãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼:", e);
        alert("ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰JSONãŒè¿”ã£ã¦ãã¦ã„ã¾ã›ã‚“");
        loadingEl.textContent = "ãƒ‡ãƒ¼ã‚¿å½¢å¼ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ";
        return;
      }

      console.log("[STATUS] parsed json:", listData);

      const journalStats = await fetchJournalStatsSafe();
      const stats = computeStats(listData, journalStats);

      renderSummary(stats);
      renderRadar(stats);
      renderBottomMetrics(stats);

      loadingEl.style.display = "none";
      mainContent.style.display = "block";
    } catch (e) {
      console.error("[STATUS] fetch error:", e);
      alert("ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆé€šä¿¡ã‚¨ãƒ©ãƒ¼ï¼‰");
      loadingEl.textContent = "èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸâ€¦";
    }
  }

  /* ==========================
     ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«çµ±è¨ˆï¼ˆå°†æ¥æ‹¡å¼µç”¨ï¼‰
  ========================== */
  async function fetchJournalStatsSafe() {
    try {
      // TODO: /journal_stats?user_id=... ãŒã§ããŸã‚‰ã“ã“ã§æœ¬ç‰©ã‚’å©ã
      // const url = `${API_BASE}/journal_stats?user_id=${encodeURIComponent(userId)}`;
      // const res = await fetch(url);
      // const data = await res.json();
      // return { count: data.count ?? 0, continueRate: data.continueRate ?? 0 };
      return {
        count: 0,
        continueRate: 0
      };
    } catch (e) {
      console.error("[STATUS] fetchJournalStats error:", e);
      return {
        count: 0,
        continueRate: 0
      };
    }
  }

  /* ==========================
     é›†è¨ˆãƒ­ã‚¸ãƒƒã‚¯
  ========================== */
  function computeStats(listData, journal) {
    const pinned = Array.isArray(listData.pinned) ? listData.pinned : [];
    const active = Array.isArray(listData.active) ? listData.active : [];
    const completed = Array.isArray(listData.completed) ? listData.completed : [];
    const allTasks = [...pinned, ...active, ...completed];

    const totalTasks = allTasks.length;
    const completedTasks = completed.length;
    const activeTasks = totalTasks - completedTasks;

    const taskCompleteRate = totalTasks
      ? Math.round((completedTasks / totalTasks) * 100)
      : 0;

    // ç›´è¿‘7æ—¥é–“ã®ç¶™ç¶šåº¦ï¼ˆä½•æ—¥ã‚¿ã‚¹ã‚¯ã‚’å®Œäº†ã—ãŸã‹ï¼‰
    const now = new Date();
    const msPerDay = 24 * 60 * 60 * 1000;
    const sevenDaysAgo = new Date(now.getTime() - 6 * msPerDay); // ä»Šæ—¥å«ã‚7æ—¥

    const perDay = {};
    let completedIn7 = 0;

    for (const t of completed) {
      if (!t.completed_at) continue;
      const dt = new Date(t.completed_at);
      if (isNaN(dt.getTime())) continue;
      if (dt < sevenDaysAgo) continue;

      const key = dt.toISOString().slice(0, 10); // yyyy-mm-dd
      perDay[key] = (perDay[key] || 0) + 1;
      completedIn7++;
    }

    const distinctDays = Object.keys(perDay).length;
    const taskContinueRate = Math.round((distinctDays / 7) * 100);

    const avgTaskPerDay = +(completedIn7 / 7).toFixed(2);
    // 1æ—¥5ä»¶å®Œäº†ã§100ç‚¹ã«ãªã‚‹ã‚ˆã†ã«ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°
    const avgTaskPerDayScaled = Math.min(
      100,
      Math.round((avgTaskPerDay / 5) * 100)
    );

    // æ„å‘³é‡ã‚¹ã‚³ã‚¢ï¼ˆã‚¿ã‚¹ã‚¯ã”ã¨ã®æ„å‘³é‡ã®å¹³å‡ï¼‰
    let meaningTotal = 0;
    let meaningCount = 0;
    for (const t of allTasks) {
      const m = meaningScoreOfTask(t);
      if (!isNaN(m) && m > 0) {
        meaningTotal += m;
        meaningCount++;
      }
    }
    const meaningScore = meaningCount
      ? Math.round(meaningTotal / meaningCount)
      : 0;

    const journalCount = journal.count || 0;
    const journalContinueRate = journal.continueRate || 0;

    return {
      totalTasks,
      completedTasks,
      activeTasks,
      taskCompleteRate,
      taskContinueRate,
      avgTaskPerDay,
      avgTaskPerDayScaled,
      meaningScore,
      journalCount,
      journalContinueRate
    };
  }

  // ã‚¿ã‚¹ã‚¯1ä»¶ã‚ãŸã‚Šã®ã€Œæ„å‘³é‡ã‚¹ã‚³ã‚¢ã€
  function meaningScoreOfTask(t) {
    const v = Number(t.vision_score ?? 0);
    const e = Number(t.excite_score ?? 0);
    const g = Number(t.growth_score ?? 0);
    const p = Number(t.priority ?? 0);

    if ([v, e, g, p].every((x) => x === 0)) return 0;

    // ä»•æ§˜ã®å¼ï¼š10Ã—(0.35*vision + 0.25*excite + 0.25*growth + 0.15*priority)
    const score = 10 * (0.35 * v + 0.25 * e + 0.25 * g + 0.15 * p);
    return Math.round(score);
  }

  /* ==========================
     DOMæ›´æ–°ç³»
  ========================== */
  function renderSummary(stats) {
    document.getElementById("totalTasks").textContent = stats.totalTasks;
    document.getElementById("completedTasks").textContent = stats.completedTasks;
    document.getElementById("activeTasks").textContent = stats.activeTasks;
    document.getElementById("journalCount").textContent = stats.journalCount;
  }

  function renderBottomMetrics(stats) {
    document.getElementById("taskCompleteRate").textContent =
      stats.taskCompleteRate;
    document.getElementById("taskCompleteDetail").textContent =
      `${stats.completedTasks} / ${stats.totalTasks} ä»¶`;
    document.getElementById("meaningScore").textContent = stats.meaningScore;
  }

  function renderRadar(stats) {
    const ctx = document.getElementById("radarChart").getContext("2d");

    const data = {
      labels: [
        "ã‚¿ã‚¹ã‚¯å®Œäº†ç‡",
        "ã‚¿ã‚¹ã‚¯ç¶™ç¶šç‡",
        "æ—¥è¨˜ç¶™ç¶šç‡",
        "æ„å‘³é‡ã‚¹ã‚³ã‚¢",
        "å¹³å‡ã‚¿ã‚¹ã‚¯é‡"
      ],
      datasets: [
        {
          label: "æˆé•·ã‚¹ã‚³ã‚¢",
          data: [
            stats.taskCompleteRate,
            stats.taskContinueRate,
            stats.journalContinueRate,
            stats.meaningScore,
            stats.avgTaskPerDayScaled
          ],
          fill: true,
          borderWidth: 2,
          pointRadius: 3
        }
      ]
    };

    const options = {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        r: {
          beginAtZero: true,
          max: 100,
          ticks: {
            stepSize: 25,
            display: true,
            showLabelBackdrop: false
          },
          grid: {
            circular: true
          }
        }
      },
      plugins: {
        legend: { display: false }
      }
    };

    if (radarChart) radarChart.destroy();
    radarChart = new Chart(ctx, {
      type: "radar",
      data,
      options
    });
  }

  // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã«å³ initï¼ˆLIST ã¨åŒã˜ã‚¹ã‚¿ã‚¤ãƒ«ï¼‰
  init();
</script>
</body>
</html>
